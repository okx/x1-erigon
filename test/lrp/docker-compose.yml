networks:
  default:
    name: ${USER_PREFIX:-default}-erigon-lrp
services:
  xlayer-mainnet-unwind:
    container_name: ${USER_PREFIX:-default}-xlayer-mainnet-unwind
    image: cdk-erigon:${IMAGE_TAG}
    environment:
      - CDK_ERIGON_SEQUENCER=0
    volumes:
      - ./mainnet/seq/:/home/erigon/data/
      - ./xlayerconfig-mainnet.yaml:/usr/src/app/config.yaml
    command: |
      integration state_stages_zkevm \
        --config=/usr/src/app/config.yaml \
        --chain xlayer-mainnet \
        --datadir /home/erigon/data/ \
        --unwind-batch-no=134484

  xlayer-mainnet-replay:
    container_name: ${USER_PREFIX:-default}-xlayer-mainnet-replay
    image: cdk-erigon:${IMAGE_TAG}
    environment:
      - CDK_ERIGON_SEQUENCER=1
    ports:
      - ${PPROF_PORT}:6060
      - ${RPC_PORT}:8545
      - ${DS_PORT}:6900
      - ${METRICS_PORT}:9095
    volumes:
      - ./mainnet/seq:/home/erigon/data/
      - ./xlayerconfig-mainnet.yaml:/usr/src/app/config.yaml
    profiles:
      - internal-ds
    command: >
      cdk-erigon --zkevm.sequencer-resequence=true --zkevm.sequencer-replay=true --zkevm.sequencer-replay-halt-on-batch-number=134500 --http.vhosts=* --http.corsdomain=* --ws --config=/usr/src/app/config.yaml

  xlayer-mainnet-replay-with-external-datastream:
    container_name: ${USER_PREFIX:-default}-xlayer-mainnet-replay
    image: cdk-erigon:${IMAGE_TAG}
    extends: xlayer-mainnet-replay
    ports:
      - ${EXTERNAL_DS_PORT}:16900
    volumes:
      - ./external_ds/data-stream.bin:/home/data-stream.bin
      - ./external_ds/data-stream.db:/home/data-stream.db/
    profiles:
      - external-ds
    command: >
      cdk-erigon --zkevm.sequencer-resequence=true --zkevm.sequencer-replay=true --zkevm.sequencer-replay-halt-on-batch-number=134500 --zkevm.sequencer-replay-external-datastream=true --http.vhosts=* --http.corsdomain=* --ws --config=/usr/src/app/config.yaml

  xlayer-executor:
    container_name: ${USER_PREFIX:-default}:-xlayer-executor
    image: hermeznetwork/zkevm-prover:v9.0.0-RC1-fork.13
    platform: linux/amd64
    environment:
      - EXPERIMENTAL_DOCKER_DESKTOP_FORCE_QEMU=1
    ports:
      - 0.0.0.0:50061:50061 # MT
      - 0.0.0.0:50071:50071 # Executor
    volumes:
      - ../config/test.stateless_executor.config.json:/usr/src/app/config.json
    command: >
      zkProver -c /usr/src/app/config.json