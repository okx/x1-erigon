apiVersion: apps/v1
kind: Deployment
metadata:
  name: defi-xlayer-rpc
  namespace: forked-test2-xgon
  uid: 8be99a0c-af8c-419e-9bb0-374b08b70d41
  resourceVersion: '618409379'
  generation: 5
  creationTimestamp: '2025-02-11T08:14:11Z'
  labels:
    app.okg.com/owner: efficiency-platform
    k8slens-edit-resource-version: v1
  annotations:
    app.okg.com/app-category: UNKNOWN
    deployment.kubernetes.io/revision: '5'
  selfLink: /apis/apps/v1/namespaces/forked-test2-xgon/deployments/defi-xlayer-rpc
status:
  observedGeneration: 5
  replicas: 1
  updatedReplicas: 1
  readyReplicas: 1
  availableReplicas: 1
  conditions:
    - type: Available
      status: 'True'
      lastUpdateTime: '2025-02-12T03:52:20Z'
      lastTransitionTime: '2025-02-12T03:52:20Z'
      reason: MinimumReplicasAvailable
      message: Deployment has minimum availability.
    - type: Progressing
      status: 'True'
      lastUpdateTime: '2025-02-12T03:52:20Z'
      lastTransitionTime: '2025-02-11T08:14:11Z'
      reason: NewReplicaSetAvailable
      message: ReplicaSet "defi-xlayer-rpc-5996d57bb5" has successfully progressed.
spec:
  replicas: 1
  selector:
    matchLabels:
      app.okcoin.com/name: defi-xlayer-rpc
  template:
    metadata:
      creationTimestamp: null
      labels:
        app.okcoin.com/name: defi-xlayer-rpc
    spec:
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: defi-xlayer-rpc-pvc
        - name: shared-memory
          emptyDir:
            medium: Memory
            sizeLimit: 8Gi
        - name: java-gc
          persistentVolumeClaim:
            claimName: java-gc
        - name: tools
          persistentVolumeClaim:
            claimName: tools
        - name: prestop
          persistentVolumeClaim:
            claimName: prestop
        - name: shared-tools
          emptyDir: {}
      containers:
        - name: defi-xlayer-rpc
          image: >-
            office-registry-vpc.cn-hongkong.cr.aliyuncs.com/defi/okchain-cdk-erigon:dev-86fc53f3-20250207223106
          command:
            - /bin/sh
            - '-c'
            - >-
              mkdir -p /home/erigon/config && curl -s
              http://dev-xlayer:8080/erigon/erigon_rpc.yaml -o
              /home/erigon/config/config.yaml && curl -s
              http://dev-xlayer:8080/erigon/alloc.json -o
              /home/erigon/config/dynamic-mynetwork-allocs.json && curl -s
              http://dev-xlayer:8080/erigon/chainspec.json -o
              /home/erigon/config/dynamic-mynetwork-chainspec.json && curl -s
              http://dev-xlayer:8080/erigon/conf.json -o
              /home/erigon/config/dynamic-mynetwork-conf.json && cdk-erigon
              --http.vhosts=* --http.corsdomain=* --ws
              --config=/home/erigon/config/config.yaml
          ports:
            - name: pprof
              containerPort: 6060
              protocol: TCP
            - name: metrics
              containerPort: 7001
              protocol: TCP
            - name: blockchain
              containerPort: 8545
              protocol: TCP
            - name: datastream
              containerPort: 6900
              protocol: TCP
          envFrom:
            - configMapRef:
                name: apollo-config
            - configMapRef:
                name: nacos-config
          env:
            - name: MY_APPLICATION_NAME
              value: defi-xlayer-rpc
            - name: MY_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: APOLLO_CLUSTER
              value: ${MY_POD_NAMESPACE}
            - name: OKTS_LANE_ENABLE
              value: 'true'
            - name: OKTS_LANE_ID
              value: $(MY_POD_NAMESPACE)
            - name: OKTS_POD_NAME
              value: $(MY_POD_NAME)
            - name: OKTS_APP_NAME
              value: $(MY_APPLICATION_NAME)
            - name: MONITOR_OPTIONS
              value: >-
                -javaagent:/app/skywalking/agent/skywalking-agent.jar
                -Dskywalking.agent.service_name=$(MY_APPLICATION_NAME)
                -Dskywalking.agent.instance_name=$(MY_POD_IP)
                -Dskywalking.agent.namespace=$(MY_POD_NAMESPACE)
                -Dskywalking.collector.backend_service=test-apmswapi.okg.com:10000
                -Dskywalking.collector.backend_http_service=test-apmswapi.okg.com:12800
            - name: DEBUG_OPTIONS
              value: >-
                -agentlib:jdwp=transport=dt_socket,address=*:7006,server=y,suspend=n
            - name: JAVA_OPTIONS
              value: '@{javaOptions} $(DEBUG_OPTIONS) $(MONITOR_OPTIONS)'
            - name: JDK17_OPTIONS
              value: '@{javaOptions} $(DEBUG_OPTIONS) $(MONITOR_OPTIONS)'
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-rpc
              value: plugin
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-rpc_ttl
              value: '1'
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-rpc_detail
              value: >-
                {"plugin":{"inputs":[{"type":"service_docker_stdout","detail":{"Stdout":true,"Stderr":true,"IncludeEnv":{"aliyun_logs_forked-test2-xgon--defi-xlayer-rpc":"plugin"},"BeginLineRegex":"\\d+-\\d+-\\d+.*"}}],"global":{"AlwaysOnline":true}}}
          resources:
            limits:
              cpu: '2'
              memory: 4Gi
            requests:
              cpu: '1'
              memory: 2Gi
          volumeMounts:
            - name: data
              mountPath: /home/erigon
            - name: shared-memory
              mountPath: /dev/shm
            - name: prestop
              mountPath: /prestop
            - name: java-gc
              mountPath: /app/gc
              subPathExpr: >-
                office-test2-cluster/$(MY_POD_NAMESPACE)/defi-xlayer-rpc/$(MY_POD_NAME)/gc
            - name: tools
              mountPath: /tools
            - name: java-gc
              mountPath: /app/dumps
              subPathExpr: >-
                office-test2-cluster/$(MY_POD_NAMESPACE)/defi-xlayer-rpc/$(MY_POD_NAME)/dumps
            - name: shared-tools
              mountPath: /app/skywalking
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: Always
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirst
      securityContext:
        fsGroup: 2000
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - 'true'
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 300
