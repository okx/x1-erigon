apiVersion: apps/v1
kind: Deployment
metadata:
  name: defi-xlayer-egseq
  namespace: forked-test2-xgon
  uid: e66e14aa-fd1a-4b26-9199-51937da9fae6
  resourceVersion: '630977527'
  generation: 44
  creationTimestamp: '2025-01-24T09:41:57Z'
  labels:
    app.okg.com/owner: efficiency-platform
    k8slens-edit-resource-version: v1
  annotations:
    app.okg.com/app-category: UNKNOWN
    deployment.kubernetes.io/revision: '36'
  selfLink: /apis/apps/v1/namespaces/forked-test2-xgon/deployments/defi-xlayer-egseq
status:
  observedGeneration: 44
  replicas: 1
  updatedReplicas: 1
  readyReplicas: 1
  availableReplicas: 1
  conditions:
    - type: Available
      status: 'True'
      lastUpdateTime: '2025-02-11T08:36:27Z'
      lastTransitionTime: '2025-02-11T08:36:27Z'
      reason: MinimumReplicasAvailable
      message: Deployment has minimum availability.
    - type: Progressing
      status: 'True'
      lastUpdateTime: '2025-02-18T03:35:12Z'
      lastTransitionTime: '2025-02-12T10:01:03Z'
      reason: NewReplicaSetAvailable
      message: ReplicaSet "defi-xlayer-egseq-b6456d7c" has successfully progressed.
spec:
  replicas: 1
  selector:
    matchLabels:
      app.okcoin.com/name: defi-xlayer-egseq
  template:
    metadata:
      creationTimestamp: null
      labels:
        app.okcoin.com/name: defi-xlayer-egseq
      annotations:
        kubectl.kubernetes.io/restartedAt: '2025-02-12T10:29:22Z'
        prometheus.io/path: /debug/metrics/prometheus
        prometheus.io/port: '7001'
        prometheus.io/scrape: 'true'
    spec:
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: defi-xlayer-egseq-pvc
        - name: config
          persistentVolumeClaim:
            claimName: dev-xlayer
        - name: shared-memory
          emptyDir:
            medium: Memory
            sizeLimit: 8Gi
        - name: java-gc
          persistentVolumeClaim:
            claimName: java-gc
        - name: tools
          persistentVolumeClaim:
            claimName: tools
        - name: prestop
          persistentVolumeClaim:
            claimName: prestop
        - name: shared-tools
          emptyDir: {}
      containers:
        - name: defi-xlayer-egseq
          image: >-
            office-registry-vpc.cn-hongkong.cr.aliyuncs.com/defi/okchain-cdk-erigon:zjg-batch-commit-492a53a3-20250218101408
          command:
            - /bin/sh
            - '-c'
            - >-
              cdk-erigon --http.vhosts=* --http.corsdomain=* --ws
              --config=/data/mainnet/xlayerconfig-mainnet.yaml
          ports:
            - name: 7001tcp
              containerPort: 7001
              protocol: TCP
            - name: 6060tcp
              containerPort: 6060
              protocol: TCP
            - name: 8545tcp
              containerPort: 8545
              protocol: TCP
            - name: 6900tcp
              containerPort: 6900
              protocol: TCP
          envFrom:
            - configMapRef:
                name: apollo-config
            - configMapRef:
                name: nacos-config
          env:
            - name: CDK_ERIGON_SEQUENCER
              value: '1'
            - name: MY_APPLICATION_NAME
              value: defi-xlayer-egseq
            - name: MY_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: APOLLO_CLUSTER
              value: ${MY_POD_NAMESPACE}
            - name: OKTS_LANE_ENABLE
              value: 'true'
            - name: OKTS_LANE_ID
              value: $(MY_POD_NAMESPACE)
            - name: OKTS_POD_NAME
              value: $(MY_POD_NAME)
            - name: OKTS_APP_NAME
              value: $(MY_APPLICATION_NAME)
            - name: MONITOR_OPTIONS
              value: >-
                -javaagent:/app/skywalking/agent/skywalking-agent.jar
                -Dskywalking.agent.service_name=$(MY_APPLICATION_NAME)
                -Dskywalking.agent.instance_name=$(MY_POD_IP)
                -Dskywalking.agent.namespace=$(MY_POD_NAMESPACE)
                -Dskywalking.collector.backend_service=test-apmswapi.okg.com:10000
                -Dskywalking.collector.backend_http_service=test-apmswapi.okg.com:12800
            - name: DEBUG_OPTIONS
              value: >-
                -agentlib:jdwp=transport=dt_socket,address=*:7006,server=y,suspend=n
            - name: JAVA_OPTIONS
              value: >-
                --add-reads java.base=ALL-UNNAMED
                -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/dumps
                -XX:MaxRAMFraction=1 -Dfile.encoding=UTF8
                -DLog4jContextSelector=org.apache.logging.log4j.core.selector.ClassLoaderContextSelector
                -Dspring.devtools.restart.enabled=false -Xdebug -Xnoagent
                -Djava.compiler=NONE $(DEBUG_OPTIONS) $(MONITOR_OPTIONS)
            - name: JDK17_OPTIONS
              value: >-
                --add-reads java.base=ALL-UNNAMED
                -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/dumps
                -XX:MaxRAMFraction=1 -Dfile.encoding=UTF8
                -DLog4jContextSelector=org.apache.logging.log4j.core.selector.ClassLoaderContextSelector
                -Dspring.devtools.restart.enabled=false -Xdebug -Xnoagent
                -Djava.compiler=NONE $(DEBUG_OPTIONS) $(MONITOR_OPTIONS)
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-egseq
              value: plugin
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-egseq_ttl
              value: '1'
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-egseq_detail
              value: >-
                {"plugin":{"inputs":[{"type":"service_docker_stdout","detail":{"Stdout":true,"Stderr":true,"IncludeEnv":{"aliyun_logs_forked-test2-xgon--defi-xlayer-egseq":"plugin"},"BeginLineRegex":"\\d+-\\d+-\\d+.*"}}],"global":{"AlwaysOnline":true}}}
          resources:
            limits:
              cpu: '8'
              memory: 32Gi
            requests:
              cpu: '4'
              memory: 16Gi
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /config
            - name: shared-memory
              mountPath: /dev/shm
            - name: prestop
              mountPath: /prestop
            - name: java-gc
              mountPath: /app/gc
              subPathExpr: >-
                office-test2-cluster/$(MY_POD_NAMESPACE)/defi-xlayer-egseq/$(MY_POD_NAME)/gc
            - name: tools
              mountPath: /tools
            - name: java-gc
              mountPath: /app/dumps
              subPathExpr: >-
                office-test2-cluster/$(MY_POD_NAMESPACE)/defi-xlayer-egseq/$(MY_POD_NAME)/dumps
            - name: shared-tools
              mountPath: /app/skywalking
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: Always
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirst
      securityContext:
        fsGroup: 2000
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - 'true'
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 0
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 300
