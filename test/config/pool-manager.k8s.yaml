apiVersion: apps/v1
kind: Deployment
metadata:
  name: defi-xlayer-plmgr
  namespace: forked-test2-xgon
  uid: f8511256-87e9-45d7-b0d9-a7b9ee692fb0
  resourceVersion: '614294512'
  generation: 1
  creationTimestamp: '2025-01-24T09:33:18Z'
  labels:
    app.okg.com/owner: efficiency-platform
  annotations:
    app.okg.com/app-category: UNKNOWN
    deployment.kubernetes.io/revision: '1'
  selfLink: /apis/apps/v1/namespaces/forked-test2-xgon/deployments/defi-xlayer-plmgr
status:
  observedGeneration: 1
  replicas: 1
  updatedReplicas: 1
  unavailableReplicas: 1
  conditions:
    - type: Progressing
      status: 'True'
      lastUpdateTime: '2025-01-24T09:34:11Z'
      lastTransitionTime: '2025-01-24T09:33:18Z'
      reason: NewReplicaSetAvailable
      message: ReplicaSet "defi-xlayer-plmgr-59c79dfd85" has successfully progressed.
    - type: Available
      status: 'False'
      lastUpdateTime: '2025-02-10T07:26:46Z'
      lastTransitionTime: '2025-02-10T07:26:46Z'
      reason: MinimumReplicasUnavailable
      message: Deployment does not have minimum availability.
spec:
  replicas: 1
  selector:
    matchLabels:
      app.okcoin.com/name: defi-xlayer-plmgr
  template:
    metadata:
      creationTimestamp: null
      labels:
        app.okcoin.com/name: defi-xlayer-plmgr
    spec:
      volumes:
        - name: shared-memory
          emptyDir:
            medium: Memory
            sizeLimit: 8Gi
        - name: java-gc
          persistentVolumeClaim:
            claimName: java-gc
        - name: tools
          persistentVolumeClaim:
            claimName: tools
        - name: prestop
          persistentVolumeClaim:
            claimName: prestop
        - name: shared-tools
          emptyDir: {}
      containers:
        - name: defi-xlayer-plmgr
          image: >-
            office-registry-vpc.cn-hongkong.cr.aliyuncs.com/defi/github-xlayer-pool-manager:dev-99cb3076-20250124141415
          command:
            - /bin/sh
            - '-c'
            - >-
                wget -q http://dev-xlayer:8080/erigon/poolmgr.toml -O /app/poolmanager.toml &&
                /app/zkevm-pool-manager run --cfg /app/poolmanager.toml
          ports:
            - name: 8545tcp
              containerPort: 8545
              protocol: TCP
          envFrom:
            - configMapRef:
                name: apollo-config
            - configMapRef:
                name: nacos-config
          env:
            - name: MY_APPLICATION_NAME
              value: defi-xlayer-plmgr
            - name: MY_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: APOLLO_CLUSTER
              value: ${MY_POD_NAMESPACE}
            - name: OKTS_LANE_ENABLE
              value: 'true'
            - name: OKTS_LANE_ID
              value: $(MY_POD_NAMESPACE)
            - name: OKTS_POD_NAME
              value: $(MY_POD_NAME)
            - name: OKTS_APP_NAME
              value: $(MY_APPLICATION_NAME)
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-plmgr
              value: plugin
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-plmgr_ttl
              value: '1'
            - name: aliyun_logs_forked-test2-xgon--defi-xlayer-plmgr_detail
              value: >-
                {"plugin":{"inputs":[{"type":"service_docker_stdout","detail":{"Stdout":true,"Stderr":true,"IncludeEnv":{"aliyun_logs_forked-test2-xgon--defi-xlayer-plmgr":"plugin"},"BeginLineRegex":"\\d+-\\d+-\\d+.*"}}],"global":{"AlwaysOnline":true}}}
          resources:
            limits:
              cpu: '2'
              memory: 4Gi
            requests:
              cpu: '1'
              memory: 2Gi
          volumeMounts:
            - name: shared-memory
              mountPath: /dev/shm
            - name: prestop
              mountPath: /prestop
            - name: java-gc
              mountPath: /app/gc
              subPathExpr: >-
                office-test2-cluster/$(MY_POD_NAMESPACE)/defi-xlayer-plmgr/$(MY_POD_NAME)/gc
            - name: tools
              mountPath: /tools
            - name: java-gc
              mountPath: /app/dumps
              subPathExpr: >-
                office-test2-cluster/$(MY_POD_NAMESPACE)/defi-xlayer-plmgr/$(MY_POD_NAME)/dumps
            - name: shared-tools
              mountPath: /app/skywalking
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: Always
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirst
      securityContext: {}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - 'true'
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 300
